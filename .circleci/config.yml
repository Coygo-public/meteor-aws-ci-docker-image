version: 2
jobs:
  build:
    working_directory: ~/app
    docker:
      - image: circleci/node:7.10
        environment:
          DOCKER_COMPOSE_VERSION: 1.18.0
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Install Docker Compose
          command: |
            curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > ~/docker-compose
            chmod +x ~/docker-compose
            sudo mv ~/docker-compose /usr/local/bin/docker-compose
      - run:
          name: build image
          command: docker-compose build
      - run:
          name: Push the docker image
          command: |
            if [ "${CIRCLE_BRANCH}" == "master" ]; then
              docker_creds='{"auths": {"https://index.docker.io/v1/": {"auth": "${DOCKER_AUTH}"}},"HttpHeaders": {"User-Agent": "Docker-Client/17.11.0-ce (linux)"}'
              mkdir -p $HOME/.docker
              echo $docker_creds > $HOME/.docker/config.json
              docker-compose push
            else
              echo "not pushing an image since we are on a branch"
            fi
